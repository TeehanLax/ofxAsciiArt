#include "ofxAsciiArt.h"

#define IS_BIT(a,b) (((a) & (1 << (b))) ? 1 : 0)
#define SQUARE(a) ((a) * (a))

unsigned char asciiFontdata[12*256] = {
	0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,
	0,126,195,129,165,129,189,153,195,126,  0,  0,
	0,126,255,255,219,255,195,231,255,126,  0,  0,
	0,  0, 34,119,127,127,127, 62, 28,  8,  0,  0,
	0,  8, 28, 62,127,127, 62, 28,  8,  0,  0,  0,
	0, 24, 60, 60,255,231,231, 24, 24,126,  0,  0,
	0, 24, 60,126,255,255,126, 24, 24,126,  0,  0,
	0,  0,  0,  0, 60,126,126, 60,  0,  0,  0,  0,
	255,255,255,255,195,129,129,195,255,255,255,255,
	0,  0, 60,126,102, 66, 66,102,126, 60,  0,  0,
	255,255,195,129,153,189,189,153,129,195,255,255,
	0,124,112, 92, 78, 31, 51, 51, 51, 30,  0,  0,
	0, 60,102,102,102, 60, 24,126, 24, 24,  0,  0,
	0,248,152,152,248, 24, 24, 30, 31, 14,  0,  0,
	0,254,198,254,198,198,198,230,231,103,  3,  0,
	0,  0, 24,219,126,231,231,126,219, 24,  0,  0,
	0,  1,  3,  7, 31,127, 31,  7,  3,  1,  0,  0,
	0, 64, 96,112,124,127,124,112, 96, 64,  0,  0,
	0, 24, 60,126, 24, 24, 24,126, 60, 24,  0,  0,
	0,102,102,102,102,102,  0,  0,102,102,  0,  0,
	0,254,219,219,219,222,216,216,216,216,  0,  0,
	0,126,198, 12, 60,102,102, 60, 48, 99,126,  0,
	0,  0,  0,  0,  0,  0,  0,127,127,127,  0,  0,
	0, 24, 60,126, 24, 24, 24,126, 60, 24,126,  0,
	0, 24, 60,126, 24, 24, 24, 24, 24, 24,  0,  0,
	0, 24, 24, 24, 24, 24, 24,126, 60, 24,  0,  0,
	0,  0,  0, 24, 48,127, 48, 24,  0,  0,  0,  0,
	0,  0,  0, 12,  6,127,  6, 12,  0,  0,  0,  0,
	0,  0,  0,  0,  3,  3,  3,127,  0,  0,  0,  0,
	0,  0,  0, 36,102,255,102, 36,  0,  0,  0,  0,
	0,  0,  8,  8, 28, 28, 62, 62,127,127,  0,  0,
	0,  0,127,127, 62, 62, 28, 28,  8,  8,  0,  0,
	0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,// ' '
	0, 12, 30, 30, 30, 12, 12,  0, 12, 12,  0,  0,// '!'
	0,102,102,102, 36,  0,  0,  0,  0,  0,  0,  0,// '"'
	0, 54, 54,127, 54, 54, 54,127, 54, 54,  0,  0,// '#'
	12, 12, 62,  3,  3, 30, 48, 48, 31, 12, 12,  0,// '$'
	0,  0,  0, 35, 51, 24, 12,  6, 51, 49,  0,  0,// '%'
	0, 14, 27, 27, 14, 95,123, 51, 59,110,  0,  0,// '&'
	0, 12, 12, 12,  6,  0,  0,  0,  0,  0,  0,  0,// '''
	0, 48, 24, 12,  6,  6,  6, 12, 24, 48,  0,  0,// '('
	0,  6, 12, 24, 48, 48, 48, 24, 12,  6,  0,  0,// ')'
	0,  0,  0,102, 60,255, 60,102,  0,  0,  0,  0,// '*'
	0,  0,  0, 24, 24,126, 24, 24,  0,  0,  0,  0,// '+'
	0,  0,  0,  0,  0,  0,  0,  0, 28, 28,  6,  0,// ','
	0,  0,  0,  0,  0,127,  0,  0,  0,  0,  0,  0,// '-'
	0,  0,  0,  0,  0,  0,  0,  0, 28, 28,  0,  0,// '.'
	0,  0, 64, 96, 48, 24, 12,  6,  3,  1,  0,  0,// '/'
	0, 62, 99,115,123,107,111,103, 99, 62,  0,  0,// '0'
	0,  8, 12, 15, 12, 12, 12, 12, 12, 63,  0,  0,// '1'
	0, 30, 51, 51, 48, 24, 12,  6, 51, 63,  0,  0,// '2'
	0, 30, 51, 48, 48, 28, 48, 48, 51, 30,  0,  0,// '3'
	0, 48, 56, 60, 54, 51,127, 48, 48,120,  0,  0,// '4'
	0, 63,  3,  3,  3, 31, 48, 48, 51, 30,  0,  0,// '5'
	0, 28,  6,  3,  3, 31, 51, 51, 51, 30,  0,  0,// '6'
	0,127, 99, 99, 96, 48, 24, 12, 12, 12,  0,  0,// '7'
	0, 30, 51, 51, 55, 30, 59, 51, 51, 30,  0,  0,// '8'
	0, 30, 51, 51, 51, 62, 24, 24, 12, 14,  0,  0,// '9'
	0,  0,  0, 28, 28,  0,  0, 28, 28,  0,  0,  0,// ':'
	0,  0,  0, 28, 28,  0,  0, 28, 28, 24, 12,  0,// ';'
	0, 48, 24, 12,  6,  3,  6, 12, 24, 48,  0,  0,// '<'
	0,  0,  0,  0,126,  0,126,  0,  0,  0,  0,  0,// '='
	0,  6, 12, 24, 48, 96, 48, 24, 12,  6,  0,  0,// '>'
	0, 30, 51, 48, 24, 12, 12,  0, 12, 12,  0,  0,// '?'
	0, 62, 99, 99,123,123,123,  3,  3, 62,  0,  0,// '@'
	0, 12, 30, 51, 51, 51, 63, 51, 51, 51,  0,  0,// 'A'
	0, 63,102,102,102, 62,102,102,102, 63,  0,  0,// 'B'
	0, 60,102, 99,  3,  3,  3, 99,102, 60,  0,  0,// 'C'
	0, 31, 54,102,102,102,102,102, 54, 31,  0,  0,// 'D'
	0,127, 70,  6, 38, 62, 38,  6, 70,127,  0,  0,// 'E'
	0,127,102, 70, 38, 62, 38,  6,  6, 15,  0,  0,// 'F'
	0, 60,102, 99,  3,  3,115, 99,102,124,  0,  0,// 'G'
	0, 51, 51, 51, 51, 63, 51, 51, 51, 51,  0,  0,// 'H'
	0, 30, 12, 12, 12, 12, 12, 12, 12, 30,  0,  0,// 'I'
	0,120, 48, 48, 48, 48, 51, 51, 51, 30,  0,  0,// 'J'
	0,103,102, 54, 54, 30, 54, 54,102,103,  0,  0,// 'K'
	0, 15,  6,  6,  6,  6, 70,102,102,127,  0,  0,// 'L'
	0, 99,119,127,127,107, 99, 99, 99, 99,  0,  0,// 'M'
	0, 99, 99,103,111,127,123,115, 99, 99,  0,  0,// 'N'
	0, 28, 54, 99, 99, 99, 99, 99, 54, 28,  0,  0,// 'O'
	0, 63,102,102,102, 62,  6,  6,  6, 15,  0,  0,// 'P'
	0, 28, 54, 99, 99, 99,115,123, 62, 48,120,  0,// 'Q'
	0, 63,102,102,102, 62, 54,102,102,103,  0,  0,// 'R'
	0, 30, 51, 51,  3, 14, 24, 51, 51, 30,  0,  0,// 'S'
	0, 63, 45, 12, 12, 12, 12, 12, 12, 30,  0,  0,// 'T'
	0, 51, 51, 51, 51, 51, 51, 51, 51, 30,  0,  0,// 'U'
	0, 51, 51, 51, 51, 51, 51, 51, 30, 12,  0,  0,// 'V'
	0, 99, 99, 99, 99,107,107, 54, 54, 54,  0,  0,// 'W'
	0, 51, 51, 51, 30, 12, 30, 51, 51, 51,  0,  0,// 'X'
	0, 51, 51, 51, 51, 30, 12, 12, 12, 30,  0,  0,// 'Y'
	0,127,115, 25, 24, 12,  6, 70, 99,127,  0,  0,// 'Z'
	0, 60, 12, 12, 12, 12, 12, 12, 12, 60,  0,  0,// '['
	0,  0,  1,  3,  6, 12, 24, 48, 96, 64,  0,  0,// '\'
	0, 60, 48, 48, 48, 48, 48, 48, 48, 60,  0,  0,// ']'
	8, 28, 54, 99,  0,  0,  0,  0,  0,  0,  0,  0,// '^'
	0,  0,  0,  0,  0,  0,  0,  0,  0,  0,255,  0,// '_'
	12, 12, 24,  0,  0,  0,  0,  0,  0,  0,  0,  0,// '`'
	0,  0,  0,  0, 30, 48, 62, 51, 51,110,  0,  0,// 'a'
	0,  7,  6,  6, 62,102,102,102,102, 59,  0,  0,// 'b'
	0,  0,  0,  0, 30, 51,  3,  3, 51, 30,  0,  0,// 'c'
	0, 56, 48, 48, 62, 51, 51, 51, 51,110,  0,  0,// 'd'
	0,  0,  0,  0, 30, 51, 63,  3, 51, 30,  0,  0,// 'e'
	0, 28, 54,  6,  6, 31,  6,  6,  6, 15,  0,  0,// 'f'
	0,  0,  0,  0,110, 51, 51, 51, 62, 48, 51, 30,// 'g'
	0,  7,  6,  6, 54,110,102,102,102,103,  0,  0,// 'h'
	0, 24, 24,  0, 30, 24, 24, 24, 24,126,  0,  0,// 'i'
	0, 48, 48,  0, 60, 48, 48, 48, 48, 51, 51, 30,// 'j'
	0,  7,  6,  6,102, 54, 30, 54,102,103,  0,  0,// 'k'
	0, 30, 24, 24, 24, 24, 24, 24, 24,126,  0,  0,// 'l'
	0,  0,  0,  0, 63,107,107,107,107, 99,  0,  0,// 'm'
	0,  0,  0,  0, 31, 51, 51, 51, 51, 51,  0,  0,// 'n'
	0,  0,  0,  0, 30, 51, 51, 51, 51, 30,  0,  0,// 'o'
	0,  0,  0,  0, 59,102,102,102,102, 62,  6, 15,// 'p'
	0,  0,  0,  0,110, 51, 51, 51, 51, 62, 48,120,// 'q'
	0,  0,  0,  0, 55,118,110,  6,  6, 15,  0,  0,// 'r'
	0,  0,  0,  0, 30, 51,  6, 24, 51, 30,  0,  0,// 's'
	0,  0,  4,  6, 63,  6,  6,  6, 54, 28,  0,  0,// 't'
	0,  0,  0,  0, 51, 51, 51, 51, 51,110,  0,  0,// 'u'
	0,  0,  0,  0, 51, 51, 51, 51, 30, 12,  0,  0,// 'v'
	0,  0,  0,  0, 99, 99,107,107, 54, 54,  0,  0,// 'w'
	0,  0,  0,  0, 99, 54, 28, 28, 54, 99,  0,  0,// 'x'
	0,  0,  0,  0,102,102,102,102, 60, 48, 24, 15,// 'y'
	0,  0,  0,  0, 63, 49, 24,  6, 35, 63,  0,  0,// 'z'
	0, 56, 12, 12,  6,  3,  6, 12, 12, 56,  0,  0,// '{'
	0, 24, 24, 24, 24,  0, 24, 24, 24, 24,  0,  0,// '|'
	0,  7, 12, 12, 24, 48, 24, 12, 12,  7,  0,  0,// '}'
	0,206, 91,115,  0,  0,  0,  0,  0,  0,  0,  0,// '~'
	0,  0,  0,  8, 28, 54, 99, 99,127,  0,  0,  0,
	0, 30, 51, 51,  3,  3,  3, 51, 51, 30, 12, 15,// '€'
	0, 51, 51,  0, 51, 51, 51, 51, 51,110,  0,  0,// ''
	48, 24, 12,  0, 30, 51, 63,  3, 51, 30,  0,  0,// '‚'
	12, 30, 51,  0, 30, 48, 62, 51, 51,110,  0,  0,// 'ƒ'
	0, 51, 51,  0, 30, 48, 62, 51, 51,110,  0,  0,// '„'
	3,  6, 12,  0, 30, 48, 62, 51, 51,110,  0,  0,// '…'
	28, 54, 54, 28, 31, 48, 62, 51, 51,110,  0,  0,// '†'
	0,  0,  0,  0, 30, 51,  3,  3, 51, 30, 12, 15,// '‡'
	12, 30, 51,  0, 30, 51, 63,  3,  3, 62,  0,  0,// 'ˆ'
	0, 51, 51,  0, 30, 51, 63,  3,  3, 62,  0,  0,// '‰'
	3,  6, 12,  0, 30, 51, 63,  3,  3, 62,  0,  0,// 'Š'
	0, 54, 54,  0, 30, 24, 24, 24, 24,126,  0,  0,// '‹'
	8, 28, 54,  0, 30, 24, 24, 24, 24,126,  0,  0,// 'Œ'
	6, 12, 24,  0, 30, 24, 24, 24, 24,126,  0,  0,// ''
	0, 51,  0, 12, 30, 51, 51, 63, 51, 51,  0,  0,// 'Ž'
	30, 51, 51, 30, 30, 51, 51, 63, 51, 51,  0,  0,// ''
	48, 24, 12, 63, 35,  3, 31,  3, 35, 63,  0,  0,// ''
	0,  0,  0,  0,127,216,254, 27, 27,247,  0,  0,// '‘'
	0,124, 30, 27, 27,127, 27, 27, 27,123,  0,  0,// '’'
	12, 30, 51,  0, 30, 51, 51, 51, 51, 30,  0,  0,// '“'
	0, 51, 51,  0, 30, 51, 51, 51, 51, 30,  0,  0,// '”'
	3,  6, 12,  0, 30, 51, 51, 51, 51, 30,  0,  0,// '•'
	12, 30, 51,  0, 51, 51, 51, 51, 51,110,  0,  0,// '–'
	3,  6, 12,  0, 51, 51, 51, 51, 51,110,  0,  0,// '—'
	0,102,102,  0,102,102,102,102, 60, 48, 24, 15,// '˜'
	51,  0, 30, 51, 51, 51, 51, 51, 51, 30,  0,  0,// '™'
	51,  0, 51, 51, 51, 51, 51, 51, 51, 30,  0,  0,// 'š'
	0, 12, 12, 30, 51,  3,  3, 51, 30, 12, 12,  0,// '›'
	60,102,  6,  6,  6, 63,  6,  6,  3,127,  0,  0,// 'œ'
	51, 51, 51, 51, 30, 63, 12, 63, 12, 12,  0,  0,// ''
	15, 17, 17, 17, 15, 17,121, 49,177, 97,  0,  0,// 'ž'
	112,216, 24, 24,126, 24, 24, 24, 27, 14,  0,  0,// 'Ÿ'
	48, 24, 12,  0, 30, 48, 62, 51, 51,110,  0,  0,// ' '
	48, 24, 12,  0, 30, 24, 24, 24, 24,126,  0,  0,// '¡'
	48, 24, 12,  0, 30, 51, 51, 51, 51, 30,  0,  0,// '¢'
	48, 24, 12,  0, 51, 51, 51, 51, 51,110,  0,  0,// '£'
	0,110, 59,  0, 31, 51, 51, 51, 51, 51,  0,  0,// '¤'
	110, 59,  0, 99,103,111,123,115, 99, 99,  0,  0,// '¥'
	0, 30, 51, 51,126,  0,127,  0,  0,  0,  0,  0,// '¦'
	0, 30, 51, 51, 30,  0,127,  0,  0,  0,  0,  0,// '§'
	0, 12, 12,  0, 12,  6,  3,  3, 51, 30,  0,  0,// '¨'
	0,  0,  0,  0,  0, 63,  3,  3,  3,  0,  0,  0,// '©'
	0,  0,  0,  0,  0, 63, 48, 48, 48,  0,  0,  0,// 'ª'
	0, 66, 99, 51, 27, 12,118,195, 97, 48,248,  0,// '«'
	0,198,103, 54, 30,236,246,219,205,252,192,  0,// '¬'
	0, 12, 12,  0, 12, 12, 30, 30, 30, 12,  0,  0,// '­'
	0,  0,  0,  0,204,102, 51, 51,102,204,  0,  0,// '®'
	0,  0,  0,  0, 51,102,204,204,102, 51,  0,  0,// '¯'
	36, 73,146, 36, 73,146, 36, 73,146, 36, 73,146,// '°'
	170, 85,170, 85,170, 85,170, 85,170, 85,170, 85,// '±'
	182,219,109,182,219,109,182,219,109,182,219,109,// '²'
	24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24,// '³'
	24, 24, 24, 24, 24, 31, 24, 24, 24, 24, 24, 24,// '´'
	24, 24, 24, 24, 31, 24, 24, 31, 24, 24, 24, 24,// 'µ'
	102,102,102,102,102,103,102,102,102,102,102,102,// '¶'
	0,  0,  0,  0,  0,127,102,102,102,102,102,102,// '·'
	0,  0,  0,  0, 31, 24, 24, 31, 24, 24, 24, 24,// '¸'
	102,102,102,102,103, 96, 96,103,102,102,102,102,// '¹'
	102,102,102,102,102,102,102,102,102,102,102,102,// 'º'
	0,  0,  0,  0,127, 96, 96,103,102,102,102,102,// '»'
	102,102,102,102,103, 96, 96,127,  0,  0,  0,  0,// '¼'
	102,102,102,102,102,127,  0,  0,  0,  0,  0,  0,// '½'
	24, 24, 24, 24, 31, 24, 24, 31,  0,  0,  0,  0,// '¾'
	0,  0,  0,  0,  0, 31, 24, 24, 24, 24, 24, 24,// '¿'
	24, 24, 24, 24, 24,248,  0,  0,  0,  0,  0,  0,// 'À'
	24, 24, 24, 24, 24,255,  0,  0,  0,  0,  0,  0,// 'Á'
	0,  0,  0,  0,  0,255, 24, 24, 24, 24, 24, 24,// 'Â'
	24, 24, 24, 24, 24,248, 24, 24, 24, 24, 24, 24,// 'Ã'
	0,  0,  0,  0,  0,255,  0,  0,  0,  0,  0,  0,// 'Ä'
	24, 24, 24, 24, 24,255, 24, 24, 24, 24, 24, 24,// 'Å'
	24, 24, 24, 24,248, 24, 24,248, 24, 24, 24, 24,// 'Æ'
	102,102,102,102,102,230,102,102,102,102,102,102,// 'Ç'
	102,102,102,102,230,  6,  6,254,  0,  0,  0,  0,// 'È'
	0,  0,  0,  0,254,  6,  6,230,102,102,102,102,// 'É'
	102,102,102,102,231,  0,  0,255,  0,  0,  0,  0,// 'Ê'
	0,  0,  0,  0,255,  0,  0,231,102,102,102,102,// 'Ë'
	102,102,102,102,230,  6,  6,230,102,102,102,102,// 'Ì'
	0,  0,  0,  0,255,  0,  0,255,  0,  0,  0,  0,// 'Í'
	102,102,102,102,231,  0,  0,231,102,102,102,102,// 'Î'
	24, 24, 24, 24,255,  0,  0,255,  0,  0,  0,  0,// 'Ï'
	102,102,102,102,102,255,  0,  0,  0,  0,  0,  0,// 'Ð'
	0,  0,  0,  0,255,  0,  0,255, 24, 24, 24, 24,// 'Ñ'
	0,  0,  0,  0,  0,255,102,102,102,102,102,102,// 'Ò'
	102,102,102,102,102,254,  0,  0,  0,  0,  0,  0,// 'Ó'
	24, 24, 24, 24,248, 24, 24,248,  0,  0,  0,  0,// 'Ô'
	0,  0,  0,  0,248, 24, 24,248, 24, 24, 24, 24,// 'Õ'
	0,  0,  0,  0,  0,254,102,102,102,102,102,102,// 'Ö'
	102,102,102,102,102,231,102,102,102,102,102,102,// '×'
	24, 24, 24, 24,255,  0,  0,255, 24, 24, 24, 24,// 'Ø'
	24, 24, 24, 24, 24, 31,  0,  0,  0,  0,  0,  0,// 'Ù'
	0,  0,  0,  0,  0,248, 24, 24, 24, 24, 24, 24,// 'Ú'
	255,255,255,255,255,255,255,255,255,255,255,255,// 'Û'
	0,  0,  0,  0,  0,  0,255,255,255,255,255,255,// 'Ü'
	15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15,// 'Ý'
	240,240,240,240,240,240,240,240,240,240,240,240,// 'Þ'
	255,255,255,255,255,255,  0,  0,  0,  0,  0,  0,// 'ß'
	0,  0,  0,  0,110,123, 51, 51,123,110,  0,  0,// 'à'
	0, 30, 51, 51, 27, 51, 51, 51, 31,  3,  6,  0,// 'á'
	0, 63, 51, 51,  3,  3,  3,  3,  3,  3,  0,  0,// 'â'
	0,127, 54, 54, 54, 54, 54, 54, 54,102,  0,  0,// 'ã'
	0, 63, 35, 38,  6, 12,  6, 38, 35, 63,  0,  0,// 'ä'
	0,  0,  0,  0,126, 19, 51, 51, 51, 30,  0,  0,// 'å'
	0,  0,  0,  0,102,102,102,102,102,222,  6,  3,// 'æ'
	0,  0,  0,110, 59, 24, 24, 24, 24,112,  0,  0,// 'ç'
	0, 63, 12, 30, 51, 51, 51, 30, 12, 63,  0,  0,// 'è'
	0, 30, 51, 51, 51, 63, 51, 51, 51, 30,  0,  0,// 'é'
	0, 62, 99, 99, 99, 99, 54, 54, 54,119,  0,  0,// 'ê'
	0, 60,  6, 12, 30, 51, 51, 51, 51, 30,  0,  0,// 'ë'
	0,  0,  0,110,219,219,219,118,  0,  0,  0,  0,// 'ì'
	0,  0, 96, 62,123,107,111, 62,  3,  0,  0,  0,// 'í'
	0, 60,  6,  3,  3, 63,  3,  3,  6, 60,  0,  0,// 'î'
	0,  0, 30, 51, 51, 51, 51, 51, 51, 51,  0,  0,// 'ï'
	0,  0, 63,  0,  0, 63,  0,  0, 63,  0,  0,  0,// 'ð'
	0,  0, 12, 12, 63, 12, 12,  0, 63,  0,  0,  0,// 'ñ'
	0,  6, 12, 24, 24, 12,  6,  0, 63,  0,  0,  0,// 'ò'
	0, 24, 12,  6,  6, 12, 24,  0, 63,  0,  0,  0,// 'ó'
	0,  0,112,216,216, 24, 24, 24, 24, 24, 24, 24,// 'ô'
	24, 24, 24, 24, 24, 24, 24, 27, 27, 14,  0,  0,// 'õ'
	0,  0, 12, 12,  0, 63,  0, 12, 12,  0,  0,  0,// 'ö'
	0,  0,206,219,115,  0,206,219,115,  0,  0,  0,// '÷'
	0, 60,102,102,102, 60,  0,  0,  0,  0,  0,  0,// 'ø'
	0,  0,  0,  0, 56, 56,  0,  0,  0,  0,  0,  0,// 'ù'
	0,  0,  0,  0,  0, 24,  0,  0,  0,  0,  0,  0,// 'ú'
	0,224, 32, 32, 32, 34, 38, 44, 56, 48,  0,  0,// 'û'
	0, 27, 54, 54, 54, 54,  0,  0,  0,  0,  0,  0,// 'ü'
	0, 30, 48, 24, 12, 62,  0,  0,  0,  0,  0,  0,// 'ý'
	0,  0, 60, 60, 60, 60, 60, 60, 60, 60,  0,  0,// 'þ'
	0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,// 'ÿ'
};


void ofxAsciiArt::init(ofTexture _source, int w, int h) {
	mode = ASCII_MODE_COLOR;
	contrast = 50.0;
	depth = 16.0;
	isReady = false;
	
	source = _source;
	ascii.loadImage("ofxAsciiArt/images/8x8.png");
	hash.allocate(256, 256, OF_IMAGE_COLOR);
	pix = ascii.getPixels();
	
	shader.load("ofxAsciiArt/shaders/ascii.vert", "ofxAsciiArt/shaders/ascii.frag");
	
	ofFbo::Settings settings;  
	settings.width = w;  
	settings.height = h;  
	settings.internalformat = GL_RGBA;  
	settings.textureTarget = GL_TEXTURE_2D;  
	fbo.allocate(settings); 
	
	buildHash();
}

void ofxAsciiArt::buildHash() {

	int startchar = 32;
	int endchar = 126;
	int a, b, c, d, e, f, g, h, i;
	int * reg;
	reg = new int[256 * 4]; 
	unsigned char * pchar = (unsigned char *)asciiFontdata;
	unsigned char *asciiMap = new unsigned char[16 * 16 * 16 * 16]; 
	
	// Step one: analyse font
	int chars;
	for (chars = startchar; chars <= endchar; chars++) {
		int charoffset = chars * 12;
		int i, j, c;
		int scratch[8 * 12];
		for (i = 0, c = 0; i < 12; i++) {
			for (j = 0; j < 8; j++, c++) {
				int cc = IS_BIT(*(pchar + i + charoffset), j) ? 255 : 0;
				scratch[i * 8 + j] = cc;
			}
		}
		
		int blurred[12 * 8];
		
		for (i = 0, c = 0; i < 12; i++) {
			for (j = 0; j < 8; j++, c++) {
				blurred[c] =
				(
				 scratch[((i + 0) % 12) * 8 + ((j + 0) % 8)] * 4 +
				 scratch[((i + 1) % 12) * 8 + ((j + 0) % 8)] * 2 * ((i == 11) ? 0 : 1) +
				 scratch[((i + 11) % 12) * 8 + ((j + 0) % 8)] * 2 * ((i == 0) ? 0 : 1) +
				 scratch[((i + 0) % 12) * 8 + ((j + 1) % 8)] * 2 * ((j == 7) ? 0 : 1) +
				 scratch[((i + 1) % 12) * 8 + ((j + 1) % 8)] * ((i == 11 || j == 7) ? 0 : 1) +
				 scratch[((i + 11) % 12) * 8 + ((j + 1) % 8)] * ((i == 0 || j == 7) ? 0 : 1) +
				 scratch[((i + 0) % 12) * 8 + ((j + 7) % 8)] * 2 * ((j == 0) ? 0 : 1) +
				 scratch[((i + 1) % 12) * 8 + ((j + 7) % 8)] * ((i == 11 || j == 0) ? 0 : 1) +
				 scratch[((i + 11) % 12) * 8 + ((j + 7) % 8)] * ((i == 0 || j == 0) ? 0 : 1)
				 ) / 8;
			}
		}
		
		e = 0;
		for (b = 0; b < 6; b++)
			for (c = 0; c < 4; c++)
				e += blurred[b * 8 + c];
		*(reg + chars * 4 + 0) = e;
		e = 0;
		for (b = 0; b < 6; b++)
			for (c = 0; c < 4; c++)
				e += blurred[b * 8 + c + 4];
		*(reg + chars * 4 + 1) = e;
		e = 0;
		for (b = 0; b < 6; b++)
			for (c = 0; c < 4; c++)
				e += blurred[b * 8 + c + 6 * 8];
		*(reg + chars * 4 + 2) = e;
		e = 0;
		for (b = 0; b < 6; b++)
			for (c = 0; c < 4; c++)
				e += blurred[b * 8 + c + 6 * 8 + 4];
		*(reg + chars * 4 + 3) = e;
	}
	
	for (a = 0; a < 16; a++) {
		for (b = 0; b < 16; b++) {
			for (c = 0; c < 16; c++) {
				for (d = 0; d < 16; d++) {
					f = 0x7fffffff;
					g = 0;
					
					for (h = startchar;h < (endchar + 1);h++) {
						i = SQUARE(*(reg + h * 4 + 0) - a * 16 * 24) +
						SQUARE(*(reg + h * 4 + 1) - b * 16 * 24) +
						SQUARE(*(reg + h * 4 + 2) - c * 16 * 24) +
						SQUARE(*(reg + h * 4 + 3) - d * 16 * 24);
						if (i < f) {
							f = i;
							g = h;
						}
					}
					
					asciiMap[(a << 12) + (b << 8) + (c << 4) + d] = g;
				}
			}
		}
	}
	delete[] reg;
	
	int x = 0;
	int y = 0;
	for(i=0; i<16*16*16*16; i++) {
		hash.setColor(x, y, ofColor(0, asciiMap[i], 0, 0));
		if(x == 255) { 
			x=0;
			y++;
		} else {
			x++; 
		}
	}
	
	hash.update();
	isReady = true;
}

void ofxAsciiArt::update() {
	if(isReady) {
		fbo.begin();
		shader.begin();
		
		shader.setAttribute1f(shader.getAttributeLocation("a_mode"), (float)mode);
		shader.setAttribute1f(shader.getAttributeLocation("a_contrast"), contrast);
		shader.setAttribute1f(shader.getAttributeLocation("a_depth"), depth);
		shader.setUniform2f("imageSize", source.getWidth(), source.getHeight());
		shader.setUniform2f("canvasSize", fbo.getWidth(), fbo.getHeight());
		shader.setUniformTexture("inputTexture", source, source.getTextureData().textureID);
		shader.setUniformTexture("asciiTexture", ascii.getTextureReference(), ascii.getTextureReference().getTextureData().textureID);
		shader.setUniformTexture("hashTexture", hash.getTextureReference(), hash.getTextureReference().getTextureData().textureID);
		
		glBegin(GL_QUADS);  
		glTexCoord2f(0, 0); glVertex3f(0, 0, 0);  
		glTexCoord2f(source.getWidth(), 0); glVertex3f(fbo.getWidth(), 0, 0);  
		glTexCoord2f(source.getWidth(), source.getHeight()); glVertex3f(fbo.getWidth(), fbo.getHeight(), 0);  
		glTexCoord2f(0, source.getHeight());  glVertex3f(0, fbo.getHeight(), 0);  
		glEnd();
		
		shader.end();
		fbo.end();
	}
}

void ofxAsciiArt::draw(int x, int y) {
	if(isReady) {
		fbo.draw(x, y, fbo.getWidth(), fbo.getHeight());
	}
}